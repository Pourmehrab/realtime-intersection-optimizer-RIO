

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>src.trajectory &mdash; AVIAN 1.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/uf_logo_AVIAN.jpg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../[0].overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../[1].simulator.html">2. Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../[1].simulator.html#module-data.data">3. Python Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../[2].intersection.html">4. Intersection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../[3].signal.html">5. Signal Phase and Timing (SPaT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../[4].trajectory.html">6. Trajectory</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AVIAN</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>src.trajectory</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for src.trajectory</h1><div class="highlight"><pre>
<span></span><span class="c1">####################################</span>
<span class="c1"># File name: trajectory.py         #</span>
<span class="c1"># Author: Mahmoud Pourmehrab       #</span>
<span class="c1"># Email: pourmehrab@gmail.com      #</span>
<span class="c1"># Last Modified: Apr/23/2018       #</span>
<span class="c1">####################################</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="c1"># -------------------------------------------------------</span>
<span class="c1"># TRAJECTORY SUPER CLASS</span>
<span class="c1"># -------------------------------------------------------</span>

<div class="viewcode-block" id="Trajectory"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.Trajectory">[docs]</a><span class="k">class</span> <span class="nc">Trajectory</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Is the abstract class for computing the trajectory points. Four subclasses inherited from this parent class:</span>
<span class="sd">        - :any:`LeadConventional`</span>
<span class="sd">        - :any:`FollowerConnected`</span>
<span class="sd">        - :any:`LeadConnected`</span>
<span class="sd">        - :any:`FollowerConventional`</span>

<span class="sd">    Any solve method under each class shall invoke :any:`set_trajectory` method at the end or does the assignment in-place.</span>

<span class="sd">    .. note:: If want to limit the trajectory planning, there are two options:</span>
<span class="sd">            - If a particular vehicle is intended to be skipped, simply set ``vehicle.reschedule_departure`` to ``False``</span>
<span class="sd">            - If the whole simulation is intended to be run without trajectory planer, set ``vehicle.reschedule_departure`` in ``main.py`` to False.</span>


<span class="sd">    :param RES: time difference between two consecutive trajectory points in seconds used in :any:`discretize_time_interval()` (be careful not to exceed max size of trajectory)</span>
<span class="sd">    :param SMALL_POS_NUM: small positive number that lower than that is approximated by zero</span>

<span class="sd">    :Author:</span>
<span class="sd">        Mahmoud Pourmehrab &lt;pourmehrab@gmail.com&gt;</span>
<span class="sd">    :Date:</span>
<span class="sd">        April-2018</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RES</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">SMALL_POS_NUM</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_speed</span><span class="p">,</span> <span class="n">min_headway</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param max_speed: Trajectories are designed to respect the this speed limit (in :math:`m/s`).</span>
<span class="sd">        :param min_headway: This is the minimum headway that vehicles in a lane can be served (in :math:`sec/veh`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_speed</span> <span class="o">=</span> <span class="n">max_speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_headway</span> <span class="o">=</span> <span class="n">min_headway</span>

<div class="viewcode-block" id="Trajectory.discretize_time_interval"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.Trajectory.discretize_time_interval">[docs]</a>    <span class="k">def</span> <span class="nf">discretize_time_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discretize the given time interval to a numpy array of time stamps</span>

<span class="sd">        .. warning:: It is inclusion-wise of the beginning and end of the interval.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">end_time</span> <span class="o">&lt;=</span> <span class="n">start_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">SMALL_POS_NUM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;cannot go backward in time&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">RES</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">SMALL_POS_NUM</span><span class="p">:</span>
            <span class="n">trj_time_stamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">Trajectory</span><span class="o">.</span><span class="n">RES</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">end_time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trj_time_stamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">SMALL_POS_NUM</span><span class="p">,</span> <span class="n">Trajectory</span><span class="o">.</span><span class="n">RES</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trj_time_stamps</span></div>

<div class="viewcode-block" id="Trajectory.set_trajectory"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.Trajectory.set_trajectory">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_trajectory</span><span class="p">(</span><span class="n">veh</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets trajectory of the vehicle and updates the first and last trajectory point index.</span>

<span class="sd">        .. note:: An assigned trajectory always is indexed from zero as the ``veh.set_first_trj_point_indx``.</span>

<span class="sd">        :param veh: the vehicle object that is owns the trajectory</span>
<span class="sd">        :type veh: Vehicle</span>
<span class="sd">        :param t: time stamps (seconds from the reference time)</span>
<span class="sd">        :param d: distances at each time stamp (in meters from the stop bar)</span>
<span class="sd">        :param s: speed at each time stamp (in :math:`m/s`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">veh</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
        <span class="n">veh</span><span class="o">.</span><span class="n">set_first_trj_point_indx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">veh</span><span class="o">.</span><span class="n">set_last_trj_point_indx</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div></div>


<span class="c1"># -------------------------------------------------------</span>
<span class="c1"># LEAD CONVENTIONAL TRAJECTORY ESTIMATOR</span>
<span class="c1"># -------------------------------------------------------</span>
<div class="viewcode-block" id="LeadConventional"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.LeadConventional">[docs]</a><span class="k">class</span> <span class="nc">LeadConventional</span><span class="p">(</span><span class="n">Trajectory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Computes the trajectory for a lead conventional vehicle assuming the vehicle tends to maintain its arrival speed.</span>

<span class="sd">Use Case:</span>

<span class="sd">    Instantiate like::</span>

<span class="sd">        &gt;&gt;&gt; lead_conventional_trj_estimator = LeadConventional(.)</span>

<span class="sd">    Perform trajectory computation by::</span>

<span class="sd">        &gt;&gt;&gt; lead_conventional_trj_estimator.solve(veh)</span>


<span class="sd">:Author:</span>
<span class="sd">    Mahmoud Pourmehrab &lt;pourmehrab@gmail.com&gt;</span>
<span class="sd">:Date:</span>
<span class="sd">    April-2018</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_speed</span><span class="p">,</span> <span class="n">min_headway</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">max_speed</span><span class="p">,</span> <span class="n">min_headway</span><span class="p">)</span>

<div class="viewcode-block" id="LeadConventional.solve"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.LeadConventional.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the trajectory of a lead conventional vehicle assuming the driver maintains its speed</span>

<span class="sd">        :param veh: the lead conventional vehicle</span>
<span class="sd">        :type veh: Vehicle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">det_time</span><span class="p">,</span> <span class="n">det_dist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">get_arrival_schedule</span><span class="p">()</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">det_dist</span> <span class="o">/</span> <span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">scheduled_departure</span> <span class="o">-</span> <span class="n">det_time</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretize_time_interval</span><span class="p">(</span><span class="n">det_time</span><span class="p">,</span> <span class="n">veh</span><span class="o">.</span><span class="n">scheduled_departure</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">det_dist</span> <span class="o">-</span> <span class="n">v</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_i</span> <span class="o">-</span> <span class="n">det_time</span><span class="p">)</span> <span class="k">for</span> <span class="n">t_i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory</span><span class="p">(</span><span class="n">veh</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></div></div>

        <span class="c1"># -------------------------------------------------------</span>
        <span class="c1"># FOLLOWER CONVENTIONAL TRAJECTORY ESTIMATOR</span>
        <span class="c1"># -------------------------------------------------------</span>


<div class="viewcode-block" id="FollowerConventional"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.FollowerConventional">[docs]</a><span class="k">class</span> <span class="nc">FollowerConventional</span><span class="p">(</span><span class="n">Trajectory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the trajectory for a follower conventional vehicle assuming a car following model. In the current implementation, Gipps car-following model [#]_ is used.</span>

<span class="sd">Use Case:</span>

<span class="sd">    Instantiate like::</span>

<span class="sd">        &gt;&gt;&gt; follower_conventional_trj_estimator = FollowerConventional(.)</span>

<span class="sd">    Perform trajectory computation by::</span>

<span class="sd">        &gt;&gt;&gt; follower_conventional_trj_estimator.solve(veh, .)</span>

<span class="sd">    :Author:</span>
<span class="sd">        Mahmoud Pourmehrab &lt;pourmehrab@gmail.com&gt;</span>
<span class="sd">    :Date:</span>
<span class="sd">        April-2018</span>

<span class="sd">.. [#] Gipps, Peter G. *A behavioural car-following model for computer simulation*. Transportation Research Part B: Methodological 15.2 (1981): 105-111 (`link &lt;https://www.sciencedirect.com/science/article/pii/0191261581900370&gt;`_).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_speed</span><span class="p">,</span> <span class="n">min_headway</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">max_speed</span><span class="p">,</span> <span class="n">min_headway</span><span class="p">)</span>

<div class="viewcode-block" id="FollowerConventional.solve"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.FollowerConventional.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veh</span><span class="p">,</span> <span class="n">lead_veh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gipps car following model is implemented. It is written in-place (does not call :any:`set_trajectory`)</span>

<span class="sd">        .. figure:: images/Gipps_formula.JPG</span>
<span class="sd">            :align: center</span>
<span class="sd">            :alt: map to buried treasure</span>

<span class="sd">            Gipps car following formula.</span>

<span class="sd">        .. note::</span>
<span class="sd">            - The only trajectory point index that changes is follower&#39;s last one.</span>
<span class="sd">            - This method relies on the fact that lead vehicle&#39;s first trajectory point is current.</span>
<span class="sd">            - Assumed the gap to lead vehicle cannot get lower than half length of the lead vehicle.</span>

<span class="sd">        :param veh: The follower conventional vehicle</span>
<span class="sd">        :type veh: Vehicle</span>
<span class="sd">        :param lead_veh: The vehicle in front of subject conventional vehicle</span>
<span class="sd">        :type lead_veh: Vehicle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">follower_trajectory</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">trajectory</span>
        <span class="n">follower_desired_speed</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">desired_speed</span>
        <span class="n">follower_max_acc</span><span class="p">,</span> <span class="n">follower_max_dec</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">max_accel_rate</span><span class="p">,</span> <span class="n">veh</span><span class="o">.</span><span class="n">max_decel_rate</span>
        <span class="n">follower_trj_indx</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">first_trj_point_indx</span>

        <span class="n">lead_trajectory</span> <span class="o">=</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">trajectory</span>
        <span class="n">lead_max_dec</span><span class="p">,</span> <span class="n">lead_length</span> <span class="o">=</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">max_decel_rate</span><span class="p">,</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">length</span>
        <span class="n">lead_trj_indx</span> <span class="o">=</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">first_trj_point_indx</span>
        <span class="n">lead_last_trj_point_indx</span> <span class="o">=</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">last_trj_point_indx</span>

        <span class="k">if</span> <span class="n">lead_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lead_trj_indx</span><span class="p">]</span> <span class="o">-</span> <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">follower_trj_indx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SMALL_POS_NUM</span><span class="p">:</span>
            <span class="n">lead_trj_indx</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># this shifts appropriately the trajectory computation</span>

        <span class="k">while</span> <span class="n">lead_trj_indx</span> <span class="o">&lt;=</span> <span class="n">lead_last_trj_point_indx</span><span class="p">:</span>
            <span class="n">next_trj_indx</span> <span class="o">=</span> <span class="n">follower_trj_indx</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">lead_speed</span> <span class="o">=</span> <span class="n">lead_trajectory</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">lead_trj_indx</span><span class="p">]</span>
            <span class="n">follower_speed</span> <span class="o">=</span> <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">follower_trj_indx</span><span class="p">]</span>
            <span class="n">gap</span> <span class="o">=</span> <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">follower_trj_indx</span><span class="p">]</span> <span class="o">-</span> <span class="n">lead_trajectory</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">lead_trj_indx</span><span class="p">]</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">lead_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lead_trj_indx</span><span class="p">]</span> <span class="o">-</span> <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">follower_trj_indx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lead_speed</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SMALL_POS_NUM</span><span class="p">:</span>  <span class="c1"># Gipps doesn&#39;t work well for near zero speed</span>
                <span class="n">v_get_behind</span> <span class="o">=</span> <span class="p">(</span><span class="n">gap</span> <span class="o">-</span> <span class="n">lead_length</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">v_get_behind</span><span class="p">,</span> <span class="n">follower_desired_speed</span><span class="p">)</span> <span class="k">if</span> <span class="n">v_get_behind</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">next_trj_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lead_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lead_trj_indx</span><span class="p">]</span>
                <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_trj_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">follower_trj_indx</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dt</span>
                <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">next_trj_indx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">follower_speed</span> <span class="o">+</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">follower_max_acc</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="n">follower_speed</span> <span class="o">/</span> <span class="n">follower_desired_speed</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                    <span class="mi">1</span> <span class="o">/</span> <span class="mi">40</span> <span class="o">+</span> <span class="n">follower_speed</span> <span class="o">/</span> <span class="n">follower_desired_speed</span><span class="p">)</span>

                <span class="n">s2</span> <span class="o">=</span> <span class="p">(</span><span class="n">follower_max_dec</span> <span class="o">*</span> <span class="p">(</span><span class="n">lead_max_dec</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">lead_length</span> <span class="o">-</span> <span class="n">gap</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">follower_max_dec</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">follower_speed</span><span class="p">))</span> <span class="o">+</span> <span class="n">lead_speed</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">lead_max_dec</span>

                <span class="k">if</span> <span class="n">s2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># determines followers next speed</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="n">follower_max_dec</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>  <span class="c1"># might get negative</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="k">if</span> <span class="n">v2</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">v1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v1</span>

            <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">next_trj_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lead_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lead_trj_indx</span><span class="p">]</span>
            <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">next_trj_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">follower_speed</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>
            <span class="n">follower_dist_to_stopbar</span> <span class="o">=</span> <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">follower_trj_indx</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">next_trj_indx</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">follower_trajectory</span><span class="p">[</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">follower_trj_indx</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">follower_trj_indx</span><span class="p">]</span> <span class="o">-</span>
                                                   <span class="n">a</span> <span class="o">*</span> <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">follower_trj_indx</span><span class="p">])</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
            <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_trj_indx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">follower_dist_to_stopbar</span><span class="p">,</span> <span class="n">lead_trajectory</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">lead_trj_indx</span><span class="p">]</span> <span class="o">+</span>
                                                        <span class="n">lead_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">follower_trj_indx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">lead_trj_indx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># This part adds the end part of follower trajectory that might left out of the domain</span>
        <span class="n">d_follower_end</span> <span class="o">=</span> <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">follower_trj_indx</span><span class="p">]</span>
        <span class="n">t_follower_end</span> <span class="o">=</span> <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">follower_trj_indx</span><span class="p">]</span>

        <span class="n">t_departure_relative</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">scheduled_departure</span> <span class="o">-</span> <span class="n">t_follower_end</span>
        <span class="k">if</span> <span class="n">t_departure_relative</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">SMALL_POS_NUM</span><span class="p">:</span>
            <span class="n">v_departure_relative</span> <span class="o">=</span> <span class="n">d_follower_end</span> <span class="o">/</span> <span class="n">t_departure_relative</span>

            <span class="n">t_augment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretize_time_interval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RES</span><span class="p">,</span> <span class="n">t_departure_relative</span><span class="p">)</span>
            <span class="n">d_augment</span> <span class="o">=</span> <span class="p">[</span><span class="n">d_follower_end</span> <span class="o">-</span> <span class="n">t</span> <span class="o">*</span> <span class="n">v_departure_relative</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_augment</span><span class="p">]</span>
            <span class="n">v_augment</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_departure_relative</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_augment</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t_augment</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">d_augment</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">v_augment</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">last_index</span> <span class="o">=</span> <span class="n">follower_trj_indx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_augment</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">follower_trj_indx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">last_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_augment</span> <span class="o">+</span> <span class="n">t_follower_end</span>
        <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">follower_trj_indx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">last_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_augment</span>
        <span class="n">follower_trajectory</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">follower_trj_indx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">last_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_augment</span>
        <span class="n">veh</span><span class="o">.</span><span class="n">set_last_trj_point_indx</span><span class="p">(</span><span class="n">last_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div></div>


<span class="kn">import</span> <span class="nn">cplex</span>


<span class="c1"># -------------------------------------------------------</span>
<span class="c1"># LEAD CONNECTED AND AUTOMATED TRAJECTORY OPTIMIZER</span>
<span class="c1"># -------------------------------------------------------</span>

<div class="viewcode-block" id="LeadConnected"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.LeadConnected">[docs]</a><span class="k">class</span> <span class="nc">LeadConnected</span><span class="p">(</span><span class="n">Trajectory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. note::</span>
<span class="sd">        - Trajectory function: :math:`f(t)   = \sum_{n=0}^{k-1} b_n \\times t^n`</span>
<span class="sd">        - Negative of speed profile: :math:`f&#39;(t)  = \sum_{n=1}^{k-1} n \\times b_n \\times t^{n-1}`</span>
<span class="sd">        - Negative of acceleration profile: :math:`f&#39;&#39;(t) = \sum_{n=2}^{k-1} n \\times (n-1) \\times  b_n \\times t^{n-2}`</span>

<span class="sd">    :param NUM_DIGS: The accuracy to keep decimals</span>
<span class="sd">    :param SPEED_DECREMENT_SIZE: The final speed decrements from maximum to 0 by step-size defined by maximum speed divided by this</span>

<span class="sd">    Use Case:</span>

<span class="sd">        Instantiate like::</span>

<span class="sd">            &gt;&gt;&gt; lead_connected_trj_optimizer = LeadConnected(.)</span>

<span class="sd">        Perform trajectory computation by::</span>

<span class="sd">            &gt;&gt;&gt; lead_conventional_trj_estimator.solve(veh)</span>

<span class="sd">    :Author:</span>
<span class="sd">        Mahmoud Pourmehrab &lt;pourmehrab@gmail.com&gt;</span>
<span class="sd">    :Date:</span>
<span class="sd">        April-2018</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NUM_DIGS</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">SPEED_DECREMENT_SIZE</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_speed</span><span class="p">,</span> <span class="n">min_headway</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Objectives:</span>
<span class="sd">            - Sets :math:`k, m` values</span>
<span class="sd">            - Sets the optimization direction</span>
<span class="sd">            - Adds variables (coefficients of the polynomial that&#39;ll represent the trajectory)</span>
<span class="sd">            - Adds two constraints that fixes the detected distance/speed on the polynomial</span>
<span class="sd">            - Adds generic form constraints with zero coefficients</span>

<span class="sd">        :param max_speed:</span>
<span class="sd">        :param min_headway:</span>
<span class="sd">        :param k: the size of array that keeps the polynomial (:math:`k-1` is the degree of polynomial)</span>
<span class="sd">        :param k: int</span>
<span class="sd">        :param m: number of points (exclusive of boundaries) to control speed/acceleration</span>
<span class="sd">        :param m: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">max_speed</span><span class="p">,</span> <span class="n">min_headway</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span> <span class="o">=</span> <span class="n">cplex</span><span class="o">.</span><span class="n">Cplex</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">objective</span><span class="o">.</span><span class="n">set_sense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">objective</span><span class="o">.</span><span class="n">sense</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">set_problem_name</span><span class="p">(</span><span class="s1">&#39;CAV trajectory optimization&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">set_problem_type</span><span class="p">(</span><span class="n">cplex</span><span class="o">.</span><span class="n">Cplex</span><span class="p">()</span><span class="o">.</span><span class="n">problem_type</span><span class="o">.</span><span class="n">LP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">datacheck</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">set_log_stream</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">set_error_stream</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">set_warning_stream</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">set_results_stream</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">var_name</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">cplex</span><span class="o">.</span><span class="n">infinity</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>

        <span class="n">constraint</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_name</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>  <span class="c1"># default must be 1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">linear_constraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">lin_expr</span><span class="o">=</span>
            <span class="p">[[[</span><span class="s2">&quot;b_0&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]],</span> <span class="p">[[</span><span class="s2">&quot;b_1&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">constraint</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">),</span>
            <span class="n">senses</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">rhs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="n">max_speed</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">),</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;det_dist&quot;</span><span class="p">,</span> <span class="s2">&quot;det_speed&quot;</span><span class="p">,</span> <span class="s2">&quot;dep_dist&quot;</span><span class="p">,</span> <span class="s2">&quot;dep_speed&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;ub_speed_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="s2">&quot;lb_speed_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;ub_acc_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span>
                      <span class="s2">&quot;lb_acc_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)])</span>

<div class="viewcode-block" id="LeadConnected.set_model"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.LeadConnected.set_model">[docs]</a>    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overrides the generic coefficients to build the specific :term:`LP` model for the AV trajectory.</span>

<span class="sd">        This model solves an :term:`LP` model to compute trajectory of AVs.</span>

<span class="sd">        .. figure:: images/model.JPG</span>
<span class="sd">           :width: 10cm</span>
<span class="sd">           :align: center</span>
<span class="sd">           :alt: map to buried treasure</span>

<span class="sd">           Part of a sample CPLEX model.</span>


<span class="sd">        :param veh: vehicle object that its trajectory is meant to be computed</span>
<span class="sd">        :type veh: Vehicle</span>
<span class="sd">        :return: CPLEX LP model. Should return the model since the follower optimizer adds constraints to this model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">amin</span><span class="p">,</span> <span class="n">amax</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">max_decel_rate</span><span class="p">,</span> <span class="n">veh</span><span class="o">.</span><span class="n">max_accel_rate</span>
        <span class="n">det_time</span><span class="p">,</span> <span class="n">det_dist</span><span class="p">,</span> <span class="n">det_speed</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">get_arrival_schedule</span><span class="p">()</span>
        <span class="n">dep_time</span><span class="p">,</span> <span class="n">dep_dist</span><span class="p">,</span> <span class="n">dep_speed</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">get_departure_schedule</span><span class="p">()</span>
        <span class="n">departure_time_relative</span> <span class="o">=</span> <span class="n">dep_time</span> <span class="o">-</span> <span class="n">det_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">objective</span><span class="o">.</span><span class="n">set_linear</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;b_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">linear_constraints</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span>
            <span class="p">[(</span><span class="s2">&quot;det_dist&quot;</span><span class="p">,</span> <span class="n">det_dist</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;det_speed&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">det_speed</span> <span class="o">*</span> <span class="n">departure_time_relative</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;dep_dist&quot;</span><span class="p">,</span> <span class="n">dep_dist</span><span class="p">),</span>
             <span class="p">(</span><span class="s2">&quot;dep_speed&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">dep_speed</span> <span class="o">*</span> <span class="n">departure_time_relative</span><span class="p">)]</span> <span class="o">+</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;ub_acc_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)],</span> <span class="p">[</span><span class="o">-</span><span class="n">amax</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">))</span> <span class="o">+</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;lb_acc_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)],</span> <span class="p">[</span><span class="o">-</span><span class="n">amin</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)))</span>

        <span class="n">var_name</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">linear_constraints</span><span class="o">.</span><span class="n">set_coefficients</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;dep_speed&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span>
                                                                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))))</span>

        <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
            <span class="n">j_prime</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">speed_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">j_prime</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)],</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">departure_time_relative</span>
            <span class="n">acc_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">speed_coeff</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)])</span> <span class="o">*</span> <span class="n">M</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">j_prime</span> <span class="o">*</span> <span class="n">departure_time_relative</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">linear_constraints</span><span class="o">.</span><span class="n">set_coefficients</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;ub_speed_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">speed_coeff</span><span class="p">))</span> <span class="o">+</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;lb_speed_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">speed_coeff</span><span class="p">))</span> <span class="o">+</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;ub_acc_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">acc_coeff</span><span class="p">))</span> <span class="o">+</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;lb_acc_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">acc_coeff</span><span class="p">)))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span></div>

<div class="viewcode-block" id="LeadConnected.solve"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.LeadConnected.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veh</span><span class="p">,</span> <span class="n">lead_veh</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves an :term:`LP` model for connected vehicle (both lead and follower)</span>

<span class="sd">        :param veh: subject vehicle</span>
<span class="sd">        :type veh: Vehicle</span>
<span class="sd">        :param lead_veh: lead vehicle which could be `None` if no vehicle is in front.</span>
<span class="sd">        :type lead_veh: Vehicle</span>
<span class="sd">        :param model:</span>
<span class="sd">        :type model: CPLEX</span>
<span class="sd">        :return: coefficients of the polynomial for the ``veh`` object and trajectory points to the trajectory attribute of it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">det_time</span><span class="p">,</span> <span class="n">det_dist</span><span class="p">,</span> <span class="n">det_speed</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">get_arrival_schedule</span><span class="p">()</span>
        <span class="n">dep_time</span><span class="p">,</span> <span class="n">dep_dist</span><span class="p">,</span> <span class="n">dep_speed</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">get_departure_schedule</span><span class="p">()</span>
        <span class="n">departure_time_relative</span> <span class="o">=</span> <span class="n">dep_time</span> <span class="o">-</span> <span class="n">det_time</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">cplex</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">CplexSolverError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised during solve&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">}:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">get_values</span><span class="p">([</span><span class="s2">&quot;b_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)]))</span>
                                  <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">departure_time_relative</span> <span class="o">**</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">f_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyder</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_trj_points</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_prime</span><span class="p">,</span> <span class="n">dep_time</span> <span class="o">-</span> <span class="n">det_time</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">det_time</span>
            <span class="n">veh</span><span class="o">.</span><span class="n">set_poly</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">lead_veh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_lead_connected_trj</span><span class="p">(</span><span class="n">veh</span><span class="p">,</span> <span class="n">departure_time_relative</span><span class="p">,</span> <span class="n">dep_speed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_follower_connected_trj</span><span class="p">(</span><span class="n">veh</span><span class="p">,</span> <span class="n">lead_veh</span><span class="p">)</span>  <span class="c1"># is defined in the child class</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory</span><span class="p">(</span><span class="n">veh</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></div>

<div class="viewcode-block" id="LeadConnected.compute_trj_points"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.LeadConnected.compute_trj_points">[docs]</a>    <span class="k">def</span> <span class="nf">compute_trj_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">f_prime</span><span class="p">,</span> <span class="n">departure_time_relative</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the polynomial trajectory to the trajectory points</span>
<span class="sd">        :param f:</span>
<span class="sd">        :param f_prime:</span>
<span class="sd">        :param departure_time_relative: span of the trajectory</span>
<span class="sd">        :return: t, d, s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretize_time_interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">departure_time_relative</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="o">-</span><span class="n">f_prime</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span></div>

<div class="viewcode-block" id="LeadConnected.optimize_lead_connected_trj"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.LeadConnected.optimize_lead_connected_trj">[docs]</a>    <span class="k">def</span> <span class="nf">optimize_lead_connected_trj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veh</span><span class="p">,</span> <span class="n">departure_time_relative</span><span class="p">,</span> <span class="n">dep_speed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes a bi-linear trajectory for the vehicle</span>

<span class="sd">        :param veh: subject vehicle</span>
<span class="sd">        :type veh: Vehicle</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">det_time</span><span class="p">,</span> <span class="n">det_dist</span><span class="p">,</span> <span class="n">det_speed</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">get_arrival_schedule</span><span class="p">()</span>
        <span class="n">t_rel_intersect</span> <span class="o">=</span> <span class="p">(</span><span class="n">det_dist</span> <span class="o">-</span> <span class="n">dep_speed</span> <span class="o">*</span> <span class="n">departure_time_relative</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">det_speed</span> <span class="o">-</span> <span class="n">dep_speed</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">t_rel_intersect</span> <span class="o">&lt;=</span> <span class="n">departure_time_relative</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretize_time_interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">departure_time_relative</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">[(</span><span class="n">departure_time_relative</span> <span class="o">-</span> <span class="n">t_i</span><span class="p">)</span> <span class="o">*</span> <span class="n">dep_speed</span> <span class="k">if</span> <span class="n">t_i</span> <span class="o">&gt;=</span> <span class="n">t_rel_intersect</span>
                 <span class="k">else</span> <span class="n">det_dist</span> <span class="o">-</span> <span class="n">det_speed</span> <span class="o">*</span> <span class="n">t_i</span> <span class="k">for</span> <span class="n">t_i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep_speed</span> <span class="k">if</span> <span class="n">t_i</span> <span class="o">&gt;=</span> <span class="n">t_rel_intersect</span> <span class="k">else</span> <span class="n">det_speed</span> <span class="k">for</span> <span class="n">t_i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">veh</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">veh</span><span class="o">.</span><span class="n">first_trj_point_indx</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;look into the matter (intersection time is not within the range)&#39;</span><span class="p">)</span></div></div>

    <span class="c1"># def optimize_follower_connected_trj(self, veh, lead_veh):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     A place holder for the optimize_follower_connected_trj() class.</span>
    <span class="c1">#</span>
    <span class="c1">#     :param veh:</span>
    <span class="c1">#     :param lead_veh:</span>
    <span class="c1">#     :return:</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     raise NotImplementedError(&quot;Must override optimize_follower_connected_trj() in the child class.&quot;)</span>


<span class="c1"># -------------------------------------------------------</span>
<span class="c1"># FOLLOWER CONNECTED AND AUTOMATED TRAJECTORY OPTIMIZER</span>
<span class="c1"># -------------------------------------------------------</span>


<div class="viewcode-block" id="FollowerConnected"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.FollowerConnected">[docs]</a><span class="k">class</span> <span class="nc">FollowerConnected</span><span class="p">(</span><span class="n">LeadConnected</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimizes the trajectory of a follower CAV.</span>

<span class="sd">    Use Case:</span>

<span class="sd">        Instantiate like::</span>

<span class="sd">            &gt;&gt;&gt; follower_connected_trj_optimizer = FollowerConnected(.)</span>

<span class="sd">        Perform trajectory computation by::</span>

<span class="sd">            &gt;&gt;&gt; model = follower_connected_trj_optimizer.set_model(.)</span>
<span class="sd">            &gt;&gt;&gt; follower_connected_trj_optimizer.solve(veh, .)</span>

<span class="sd">    :param GAP_CTRL_STARTS: This is the relative time when gap control constraints get added</span>
<span class="sd">    :param SAFE_MIN_GAP: The minimum safe distance to keep from lead vehicles (in :math:`m`) [*can be speed dependent*]</span>

<span class="sd">    :Author:</span>
<span class="sd">        Mahmoud Pourmehrab &lt;pourmehrab@gmail.com&gt;</span>
<span class="sd">    :Date:</span>
<span class="sd">        April-2018</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">GAP_CTRL_STARTS</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">SAFE_MIN_GAP</span> <span class="o">=</span> <span class="mf">4.8</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_speed</span><span class="p">,</span> <span class="n">min_headway</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the safe headway constraints at the control points to the inherited model.</span>

<span class="sd">        :param max_speed:</span>
<span class="sd">        :param min_headway:</span>
<span class="sd">        :param k:</span>
<span class="sd">        :param m:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">max_speed</span><span class="p">,</span> <span class="n">min_headway</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>

        <span class="n">constraint</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;b_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">linear_constraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lin_expr</span><span class="o">=</span><span class="p">[</span><span class="n">constraint</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">senses</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                                              <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;min_gap_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)])</span>

<div class="viewcode-block" id="FollowerConnected.set_model"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.FollowerConnected.set_model">[docs]</a>    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veh</span><span class="p">,</span> <span class="n">lead_veh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the LP model using the extra constraints to enforce the safe headway. Either three cases happen here:</span>
<span class="sd">            - The lead is a :term:`CNV` and its trajectory overlaps and it has enough trajectory points</span>
<span class="sd">                - Enforce the constraint on last m trajectory points of the lead vehicle</span>
<span class="sd">            - The lead is a :term:`CAV` and its trajectory overlaps</span>
<span class="sd">                - Evaluate the polynomial over m points as defined in the paper</span>
<span class="sd">            - Otherwise</span>
<span class="sd">                - Relax the constraints (:math:`0.0 \geq -1.0` is always true)</span>

<span class="sd">        :param veh: follower connected vehicle that the trajectory model is constructed for</span>
<span class="sd">        :type veh: Vehicle</span>
<span class="sd">        :param lead_veh: the vehicle in front</span>
<span class="sd">        :type lead_veh: Vehicle</span>
<span class="sd">        :return: the CPLEX LP model to be solved by solve() method</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">veh</span><span class="p">)</span>

        <span class="n">follower_det_time</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">get_arrival_schedule</span><span class="p">()</span>
        <span class="n">follower_dep_time</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">get_departure_schedule</span><span class="p">()</span>
        <span class="n">lead_dep_time</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">get_departure_schedule</span><span class="p">()</span>
        <span class="n">start_relative_ctrl_time</span><span class="p">,</span> <span class="n">end_relative_ctrl_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAP_CTRL_STARTS</span><span class="p">,</span> <span class="n">lead_dep_time</span> <span class="o">-</span> <span class="n">follower_det_time</span>
        <span class="n">departure_time_relative</span> <span class="o">=</span> <span class="n">follower_dep_time</span> <span class="o">-</span> <span class="n">follower_det_time</span>

        <span class="k">if</span> <span class="n">end_relative_ctrl_time</span> <span class="o">&gt;</span> <span class="n">start_relative_ctrl_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SMALL_POS_NUM</span><span class="p">:</span>
            <span class="n">n_traj_lead</span> <span class="o">=</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">last_trj_point_indx</span> <span class="o">-</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">first_trj_point_indx</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">n_traj_lead</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">((</span><span class="n">n_traj_lead</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
                <span class="n">ctrl_lead_relative_time</span> <span class="o">=</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">lead_veh</span><span class="o">.</span><span class="n">last_trj_point_indx</span><span class="p">:</span><span class="n">lead_veh</span><span class="o">.</span><span class="n">last_trj_point_indx</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span><span class="n">step</span><span class="p">]</span> <span class="o">-</span> \
                                          <span class="n">follower_det_time</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">lead_veh</span><span class="o">.</span><span class="n">last_trj_point_indx</span><span class="p">:</span><span class="n">lead_veh</span><span class="o">.</span><span class="n">last_trj_point_indx</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span><span class="n">step</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAFE_MIN_GAP</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctrl_lead_relative_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctrl_lead_relative_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">linear_constraints</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;min_gap_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)],</span> <span class="n">rhs</span><span class="p">))</span>
        <span class="n">var_name</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctrl_lead_relative_time</span><span class="p">):</span>
            <span class="n">dist_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">time</span> <span class="o">/</span> <span class="n">departure_time_relative</span><span class="p">)</span> <span class="o">**</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span><span class="o">.</span><span class="n">linear_constraints</span><span class="o">.</span><span class="n">set_coefficients</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;min_gap_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">dist_coeff</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lp_model</span></div>

<div class="viewcode-block" id="FollowerConnected.solve"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.FollowerConnected.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veh</span><span class="p">,</span> <span class="n">lead_veh</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param veh: subject vehicle</span>
<span class="sd">        :type veh: Vehicle</span>
<span class="sd">        :param lead_veh: the vehicle in front of the subject</span>
<span class="sd">        :type lead_veh: Vehicle</span>
<span class="sd">        :param model:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">veh</span><span class="p">,</span> <span class="n">lead_veh</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span></div>

<div class="viewcode-block" id="FollowerConnected.optimize_follower_connected_trj"><a class="viewcode-back" href="../../[4].trajectory.html#src.trajectory.FollowerConnected.optimize_follower_connected_trj">[docs]</a>    <span class="k">def</span> <span class="nf">optimize_follower_connected_trj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veh</span><span class="p">,</span> <span class="n">lead_veh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. warning::</span>
<span class="sd">            This method is called in the parent class (:any:`FollowerConnected`) solve method.</span>

<span class="sd">        :param veh: subject vehicle</span>
<span class="sd">        :type veh: Vehicle</span>
<span class="sd">        :param lead_veh: lead vehicle which could be `None` if no vehicle is in front.</span>
<span class="sd">        :type lead_veh: Vehicle</span>
<span class="sd">        :return: trajectory of the subject vehicle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lead_dep_time</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">get_departure_schedule</span><span class="p">()</span>
        <span class="n">foll_det_time</span><span class="p">,</span> <span class="n">foll_det_dist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">get_arrival_schedule</span><span class="p">()</span>
        <span class="n">foll_dep_time</span><span class="p">,</span> <span class="n">foll_dep_dist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">get_departure_schedule</span><span class="p">()</span>
        <span class="n">dep_headway</span> <span class="o">=</span> <span class="n">foll_dep_time</span> <span class="o">-</span> <span class="n">lead_dep_time</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">lead_veh</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[:,</span> <span class="n">lead_veh</span><span class="o">.</span><span class="n">first_trj_point_indx</span><span class="p">:</span><span class="n">lead_veh</span><span class="o">.</span><span class="n">last_trj_point_indx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">dep_headway</span>  <span class="c1"># to shift the trajectory</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">foll_det_time</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">foll_det_dist</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dt</span>
        <span class="n">t_augment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretize_time_interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">d_augment</span> <span class="o">=</span> <span class="p">[</span><span class="n">foll_det_dist</span> <span class="o">-</span> <span class="n">v</span> <span class="o">*</span> <span class="n">t_i</span> <span class="k">for</span> <span class="n">t_i</span> <span class="ow">in</span> <span class="n">t_augment</span><span class="p">]</span>
        <span class="n">s_augment</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_augment</span><span class="p">)</span>
        <span class="n">t_augment</span> <span class="o">+=</span> <span class="n">foll_det_time</span>

        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">,</span> <span class="p">[[</span><span class="n">t_augment</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">],</span> <span class="p">[</span><span class="n">d_augment</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">],</span> <span class="p">[</span><span class="n">s_augment</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">]])</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Mahmoud Pourmehrab.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/copybutton.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>